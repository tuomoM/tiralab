<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compression</a> &gt; <a href="index.source.html" class="el_package">compression</a> &gt; <span class="el_source">FileService.java</span></div><h1>FileService.java</h1><pre class="source lang-java linenums">/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package compression;
import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.NoSuchElementException;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.lang.Integer;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.File;
import java.nio.charset.StandardCharsets;
import java.lang.StringBuilder;
/**
 * Class to handle file operations for compression.
 * Provides methods for writing and reading binary data
 * @author tuomomehtala
 */
public class FileService {
    private BufferedInputStream ioIn;
    private BufferedOutputStream ioOut;
    private int buffer;
    private int index;
    private int outBuffer;
    private int outIndex;  
    private boolean active;
    private byte[] outBufferall;
    private int inCounter,outCounter;
    
    /**
     * Obsolote constructor 
     * @param in
     * @param out 
     */
<span class="fc" id="L40">    public FileService(BufferedInputStream in, BufferedOutputStream out){</span>
<span class="fc" id="L41">        this.ioIn = in;</span>
<span class="fc" id="L42">        this.ioOut = out;</span>
<span class="fc" id="L43">        this.index = 0;</span>
<span class="fc" id="L44">        this.buffer = 0;</span>
<span class="fc" id="L45">        this.outBuffer = 0;</span>
<span class="fc" id="L46">        this.active = true;</span>
<span class="fc" id="L47">        fillInBuffer();</span>
       
        
<span class="fc" id="L50">    }</span>
    /**
     * Constructor
     * @param inputFile name of the file to be read 
     * @param outputFile name of the file to be written
     * @throws IOException 
     */
<span class="fc" id="L57">    public FileService(String inputFile,String outputFile) throws IOException{</span>
<span class="fc" id="L58">           int k  = 64;</span>
<span class="fc" id="L59">               ioIn = new BufferedInputStream(new FileInputStream(inputFile),(1024*k));</span>
           
<span class="fc" id="L61">              ioOut = new BufferedOutputStream(new FileOutputStream(outputFile),(1024*k));</span>
<span class="fc" id="L62">               this.index = 0;</span>
<span class="fc" id="L63">        this.buffer = 0;</span>
<span class="fc" id="L64">        this.outBuffer = 0;</span>
<span class="fc" id="L65">        this.active = true;</span>
<span class="fc" id="L66">        fillInBuffer();</span>
       
<span class="fc" id="L68">    }</span>
    /**
     * 
     * @return value true if file is empty 
     */
    public boolean inEmpty(){
<span class="fc bfc" id="L74" title="All 2 branches covered.">        return index == -1;</span>
    }
    /**
     * Internal method for filling the 8 bit buffer
     */
    private void fillInBuffer(){
<span class="pc bpc" id="L80" title="2 of 4 branches missed.">        if(buffer == 0 &amp;&amp; index &gt; -1){</span>
            try{
                
<span class="fc" id="L83">                this.buffer = ioIn.read();</span>
             //   System.out.println(&quot;read byte:&quot;+buffer);
<span class="fc bfc" id="L85" title="All 2 branches covered.">                if(buffer == -1){</span>
<span class="fc" id="L86">                    index = -1;</span>
<span class="fc" id="L87">                    buffer= 0;        </span>
                }else{
<span class="fc" id="L89">                index = 8;</span>
<span class="fc" id="L90">                inCounter++;</span>
                }
<span class="nc" id="L92">            }catch(Exception e){</span>
<span class="nc" id="L93">                System.out.println(&quot;EOF: &quot;+e.getLocalizedMessage());</span>
<span class="nc" id="L94">                index = -1;</span>
<span class="fc" id="L95">            }</span>
        }
        
<span class="fc" id="L98">    }</span>
    /**
     * Reads one bit from file
     * @return return true for 1 and false for 0
     */
    public boolean readBit(){ 
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
       
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if(inEmpty()) throw new NoSuchElementException(&quot;Eof at: &quot;+inCounter);</span>
        
<span class="fc" id="L108">        index --;</span>
   
        
<span class="fc bfc" id="L111" title="All 2 branches covered.">        boolean value = ((buffer &gt;&gt; index)&amp; 1)==1;</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if(index &lt;= 0) {</span>
<span class="fc" id="L113">            index = 0;</span>
<span class="fc" id="L114">            buffer = 0;</span>
<span class="fc" id="L115">            fillInBuffer();</span>
        }
<span class="fc" id="L117">        return value;</span>
        
      
    }
    /**
     * Reads the whole file into a String with transformation of 1 byte = 1 character
     * @return String value of all bytes
     */
    public String readFile(){
<span class="fc" id="L126">        String data = &quot;&quot;;</span>
        
        try{
<span class="fc" id="L129">        byte[] bytes = ioIn.readAllBytes();</span>
<span class="fc" id="L130">        char[] table = new char[bytes.length];</span>
<span class="fc" id="L131">        StringBuilder strB = new StringBuilder(bytes.length);</span>
           
            //System.out.println(&quot;all bytes read&quot;);
<span class="fc" id="L134">        strB.append((char)(buffer &amp; 0xff));    </span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">        for(int i = 0; i &lt; bytes.length;i++){</span>
           
<span class="fc" id="L137">           strB.append((char)(bytes[i] &amp; 0xff));</span>
  
        }
<span class="fc" id="L140">        data = strB.toString();</span>

<span class="nc" id="L142">        }catch(IOException e){</span>
<span class="nc" id="L143">            System.out.println(&quot;Error reading file &quot;+e.getLocalizedMessage());</span>
<span class="fc" id="L144">        }</span>
<span class="fc" id="L145">        index = 8;</span>
<span class="fc" id="L146">        buffer = 0;</span>
<span class="fc" id="L147">        fillInBuffer();</span>
<span class="fc" id="L148">        return data;</span>
    }
    /**
     * Read one byte char from file
     * @return byte as char
     */
    public char readChar(){
       
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L157">        int data = 0;</span>
      
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if(index == 8){</span>
      
<span class="fc" id="L161">            data = buffer;</span>
<span class="fc" id="L162">            index = 0;</span>
<span class="fc" id="L163">            buffer = 0;</span>
<span class="fc" id="L164">            fillInBuffer();</span>
          //  System.out.println(&quot;returning char: &quot;+data);
<span class="fc" id="L166">            return (char)(data &amp; 0xff);</span>
        }else{
<span class="fc" id="L168">            data = buffer;</span>
<span class="fc" id="L169">            int localIndex = index;</span>
<span class="fc" id="L170">            buffer = 0;</span>
<span class="fc" id="L171">            index = 0;</span>
<span class="fc" id="L172">            fillInBuffer();</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">            if(inEmpty()) throw new NoSuchElementException(&quot;Eof&quot;);</span>
          //  System.out.println(&quot;moving : &quot; +(8-localIndex)+&quot; bits&quot;);
<span class="fc" id="L175">            data &lt;&lt;= (8-localIndex);</span>
<span class="fc" id="L176">            index = localIndex;</span>
<span class="fc" id="L177">            data |= (buffer &gt;&gt;&gt; index);</span>
           //   System.out.println(&quot;returning char: &quot;+data);
<span class="fc" id="L179">            return (char)(data &amp; 0xff) ; // takes 256 (the lowest byte)</span>
            
            
            
            
        }
        
        
        
    }
    /**
     * read one byte as int 
     * @return byte value as int.
     */
    public int readByteAsInt(){
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L195">        int data = 0;</span>
      
<span class="fc bfc" id="L197" title="All 2 branches covered.">        if(index == 8){</span>
      
<span class="fc" id="L199">            data = buffer;</span>
<span class="fc" id="L200">            index = 0;</span>
<span class="fc" id="L201">            buffer = 0;</span>
<span class="fc" id="L202">            fillInBuffer();</span>
<span class="fc" id="L203">            return data;</span>
        }else{
<span class="fc" id="L205">            data = buffer;</span>
<span class="fc" id="L206">            int localIndex = index;</span>
<span class="fc" id="L207">            buffer = 0;</span>
<span class="fc" id="L208">            index = 0;</span>
<span class="fc" id="L209">            fillInBuffer();</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">            if(inEmpty()) throw new NoSuchElementException(&quot;Eof&quot;);</span>
<span class="fc" id="L211">            data &lt;&lt;= (8-localIndex);</span>
<span class="fc" id="L212">            index = localIndex;</span>
<span class="fc" id="L213">            data |= (buffer &gt;&gt;&gt; index);</span>
<span class="fc" id="L214">            return data%256;</span>
            
            
            
            
        }
      
        
    }
    public int getInCounter(){
<span class="nc" id="L224">        return this.inCounter;</span>
    }
    public int getOutCounter(){
<span class="fc" id="L227">        return this.outCounter;</span>
    }
    /**
     * Internal method to empty program out buffer
     */
    private void writeOutput(){
        try{
<span class="fc" id="L234">            ioOut.write(outBuffer);</span>
        
          //  System.out.println(&quot;wrote byte: &quot;+outBuffer);
<span class="fc" id="L237">            outBuffer = 0;</span>
<span class="fc" id="L238">            outIndex = 0;</span>
<span class="fc" id="L239">            outCounter++;</span>
            
<span class="nc" id="L241">        }catch(IOException e){</span>
<span class="nc" id="L242">            System.out.println(&quot;Exception in writing to file: &quot;+e.getLocalizedMessage() );</span>
<span class="fc" id="L243">        }</span>
<span class="fc" id="L244">    }</span>
    /**
     * Write one bit to file
     * @param bit true for 1 and false for 0
     */
    public void writeBoolean(boolean bit){
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L251">        outBuffer &lt;&lt;= 1; //add one bit to right</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">        if(bit) outBuffer |= 1;</span>
         //System.out.println(&quot;wrote out: &quot;+bit);
<span class="fc" id="L254">        outIndex++;</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">        if(outIndex &gt;= 8) writeOutput();</span>
<span class="fc" id="L256">    }</span>
    /**
     * Write byte size int to file
     * @param value to be written
     */
    public void writeByte(int value){
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);    </span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if(outIndex == 0){</span>
           // System.out.println(&quot;writing a full byte&quot;);
<span class="fc" id="L265">            outBuffer = value;</span>
<span class="fc" id="L266">            outIndex = 8;</span>
<span class="fc" id="L267">            writeOutput();</span>
        }else{
          //  System.out.println(&quot;writing byte bit by bit&quot;);
<span class="fc bfc" id="L270" title="All 2 branches covered.">              for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">            boolean bit = ((value &gt;&gt;&gt; (8 - i - 1)) &amp; 1) == 1;</span>
<span class="fc" id="L272">            writeBoolean(bit);</span>
                 
        }
//            for(int i = 7; i&lt;=0;i--){
//                System.out.println(&quot;adding individual bits: &quot;+i);
//                 if(value &lt;&lt; ~i&lt;0){
//                     writeBoolean(true);
//                     System.out.println(&quot;true&quot;);
//                 }else{
//                     writeBoolean(false);
//                     System.out.println(&quot;false&quot;);
//                 }
//            }
        }
<span class="fc" id="L286">    }</span>
    /**
     * Writes integer with the predefined length as bits out.
     * Will throw exception if the length is larger than max int length 32
     * @param value the value to be written
     * @param length the amount of bits to be used
     */
    public void writeInt(int value, int length){
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">        if(length == 32 ){</span>
<span class="nc" id="L295">            writeInt(value);</span>
        }
<span class="pc bpc" id="L297" title="2 of 4 branches missed.">        if(length &lt; 1 || length &gt; 32) throw new IllegalStateException(&quot;illegal int length&quot;);</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">        for(int i = 0; i&lt;length;i++){</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">               boolean bit = ((value &gt;&gt;&gt; (length - i - 1)) &amp; 1) == 1;</span>
<span class="fc" id="L300">               writeBoolean(bit);</span>
        }
<span class="fc" id="L302">    }</span>
    /**
     * Reads a specific length integer from file
     * @param length length in bits.
     * @return 
     */
    public int readInt(int length){
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">        if(length == 32) return readInt();</span>
<span class="pc bpc" id="L310" title="2 of 4 branches missed.">        if(length &lt; 1 || length &gt; 32) throw new IllegalStateException(&quot;illegal int length&quot;);</span>
<span class="fc" id="L311">        int result = 0;</span>
<span class="fc bfc" id="L312" title="All 2 branches covered.">        for(int i = 0; i&lt; length;i++){</span>
<span class="fc" id="L313">            boolean bit = readBit();</span>
<span class="fc" id="L314">            result &lt;&lt;= 1;</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">            if(bit){</span>
<span class="fc" id="L316">                result |= 1;</span>
            }
        }
        
        
<span class="fc" id="L321">        return result;</span>
    }
    /**
     * Writes integer to file (4 bytes)
     * @param value to be written
     */
    public void writeInt(int value){
<span class="fc" id="L328">        byte[] b = ByteBuffer.allocate(4).putInt(value).array();</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">        for(int i = 0; i&lt;4;i++){</span>
<span class="fc" id="L330">            writeByte(b[i]);</span>
        }
        
<span class="fc" id="L333">    }</span>
    /**
     * Reads 4 bytes from disk and returns it as integer
     * @return integer value of 4 next bytes
     */
    public int readInt(){
<span class="fc" id="L339">        byte[] b = new byte[4];</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">        for(int i = 0; i&lt;4;i++){</span>
<span class="fc" id="L341">            int x = readByteAsInt();</span>
<span class="fc" id="L342">            b[i] =(byte) (x &amp; 0xff);</span>
        }
<span class="fc" id="L344">        return ByteBuffer.wrap(b).getInt();</span>
        
    }
    /**
     * Writes the buffer out and padds it with 0s before closing the file.
     */
    public void close(){
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L352">        this.active = false;</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">        if(outIndex&gt;0){</span>
<span class="fc" id="L354">            outBuffer &lt;&lt;= (8-outIndex); // pad last byte with zeroes to end.</span>
<span class="fc" id="L355">            writeOutput();</span>
        }
        try{
<span class="fc" id="L358">            ioOut.flush();</span>
<span class="fc" id="L359">            ioIn.close();</span>
<span class="fc" id="L360">            ioOut.close();</span>
<span class="nc" id="L361">        }catch(IOException e){</span>
<span class="nc" id="L362">            System.out.println(&quot;Exception in closing file inteface: &quot;+e.getLocalizedMessage());</span>
<span class="fc" id="L363">        }</span>
<span class="fc" id="L364">    }  </span>
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>