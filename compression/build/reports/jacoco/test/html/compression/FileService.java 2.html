<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compression</a> &gt; <a href="index.source.html" class="el_package">compression</a> &gt; <span class="el_source">FileService.java</span></div><h1>FileService.java</h1><pre class="source lang-java linenums">/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package compression;
import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.NoSuchElementException;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.lang.Integer;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.File;
import java.nio.charset.StandardCharsets;
import java.lang.StringBuilder;
/**
 *
 * @author tuomomehtala
 */
public class FileService {
    private BufferedInputStream ioIn;
    private BufferedOutputStream ioOut;
    private int buffer;
    private int index;
    private int outBuffer;
    private int outIndex;  
    private boolean active;
    private byte[] outBufferall;
    private int inCounter,outCounter;
    
    
<span class="fc" id="L35">    public FileService(BufferedInputStream in, BufferedOutputStream out){</span>
<span class="fc" id="L36">        this.ioIn = in;</span>
<span class="fc" id="L37">        this.ioOut = out;</span>
<span class="fc" id="L38">        this.index = 0;</span>
<span class="fc" id="L39">        this.buffer = 0;</span>
<span class="fc" id="L40">        this.outBuffer = 0;</span>
<span class="fc" id="L41">        this.active = true;</span>
<span class="fc" id="L42">        fillInBuffer();</span>
       
        
<span class="fc" id="L45">    }</span>
<span class="fc" id="L46">    public FileService(String inputFile,String outputFile) throws IOException{</span>
<span class="fc" id="L47">           int k  = 64;</span>
<span class="fc" id="L48">               ioIn = new BufferedInputStream(new FileInputStream(inputFile),(1024*k));</span>
           
<span class="fc" id="L50">              ioOut = new BufferedOutputStream(new FileOutputStream(outputFile),(1024*k));</span>
<span class="fc" id="L51">               this.index = 0;</span>
<span class="fc" id="L52">        this.buffer = 0;</span>
<span class="fc" id="L53">        this.outBuffer = 0;</span>
<span class="fc" id="L54">        this.active = true;</span>
<span class="fc" id="L55">        fillInBuffer();</span>
       
<span class="fc" id="L57">    }</span>
    public boolean inEmpty(){
<span class="fc bfc" id="L59" title="All 2 branches covered.">        return index == -1;</span>
    }
    private void fillInBuffer(){
<span class="pc bpc" id="L62" title="2 of 4 branches missed.">        if(buffer == 0 &amp;&amp; index &gt; -1){</span>
            try{
                
<span class="fc" id="L65">                this.buffer = ioIn.read();</span>
             //   System.out.println(&quot;read byte:&quot;+buffer);
<span class="fc bfc" id="L67" title="All 2 branches covered.">                if(buffer == -1){</span>
<span class="fc" id="L68">                    index = -1;</span>
<span class="fc" id="L69">                    buffer= 0;        </span>
                }else{
<span class="fc" id="L71">                index = 8;</span>
<span class="fc" id="L72">                inCounter++;</span>
                }
<span class="nc" id="L74">            }catch(Exception e){</span>
<span class="nc" id="L75">                System.out.println(&quot;EOF: &quot;+e.getLocalizedMessage());</span>
<span class="nc" id="L76">                index = -1;</span>
<span class="fc" id="L77">            }</span>
        }
        
<span class="fc" id="L80">    }</span>
    public boolean readBit(){ 
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
       
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if(inEmpty()) throw new NoSuchElementException(&quot;Eof at: &quot;+inCounter);</span>
        
<span class="fc" id="L86">        index --;</span>
   
        
<span class="fc bfc" id="L89" title="All 2 branches covered.">        boolean value = ((buffer &gt;&gt; index)&amp; 1)==1;</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if(index &lt;= 0) {</span>
<span class="fc" id="L91">            index = 0;</span>
<span class="fc" id="L92">            buffer = 0;</span>
<span class="fc" id="L93">            fillInBuffer();</span>
        }
<span class="fc" id="L95">        return value;</span>
        
      
    }
    public String readFile(){
<span class="fc" id="L100">        String data = &quot;&quot;;</span>
        
        try{
<span class="fc" id="L103">        byte[] bytes = ioIn.readAllBytes();</span>
<span class="fc" id="L104">        char[] table = new char[bytes.length];</span>
<span class="fc" id="L105">        StringBuilder strB = new StringBuilder(bytes.length);</span>
           
            //System.out.println(&quot;all bytes read&quot;);
<span class="fc" id="L108">        strB.append((char)(buffer &amp; 0xff));    </span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        for(int i = 0; i &lt; bytes.length;i++){</span>
           
<span class="fc" id="L111">           strB.append((char)(bytes[i] &amp; 0xff));</span>
  
        }
<span class="fc" id="L114">        data = strB.toString();</span>

<span class="nc" id="L116">        }catch(IOException e){</span>
<span class="nc" id="L117">            System.out.println(&quot;Error reading file &quot;+e.getLocalizedMessage());</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">        index = 8;</span>
<span class="fc" id="L120">        buffer = 0;</span>
<span class="fc" id="L121">        fillInBuffer();</span>
<span class="fc" id="L122">        return data;</span>
    }
    public char readChar(){
       
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L127">        int data = 0;</span>
      
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if(index == 8){</span>
      
<span class="fc" id="L131">            data = buffer;</span>
<span class="fc" id="L132">            index = 0;</span>
<span class="fc" id="L133">            buffer = 0;</span>
<span class="fc" id="L134">            fillInBuffer();</span>
          //  System.out.println(&quot;returning char: &quot;+data);
<span class="fc" id="L136">            return (char)(data &amp; 0xff);</span>
        }else{
<span class="fc" id="L138">            data = buffer;</span>
<span class="fc" id="L139">            int localIndex = index;</span>
<span class="fc" id="L140">            buffer = 0;</span>
<span class="fc" id="L141">            index = 0;</span>
<span class="fc" id="L142">            fillInBuffer();</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">            if(inEmpty()) throw new NoSuchElementException(&quot;Eof&quot;);</span>
          //  System.out.println(&quot;moving : &quot; +(8-localIndex)+&quot; bits&quot;);
<span class="fc" id="L145">            data &lt;&lt;= (8-localIndex);</span>
<span class="fc" id="L146">            index = localIndex;</span>
<span class="fc" id="L147">            data |= (buffer &gt;&gt;&gt; index);</span>
           //   System.out.println(&quot;returning char: &quot;+data);
<span class="fc" id="L149">            return (char)(data &amp; 0xff) ; // takes 256 (the lowest byte)</span>
            
            
            
            
        }
        
        
        
    }
    public int readByteAsInt(){
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L161">        int data = 0;</span>
      
<span class="fc bfc" id="L163" title="All 2 branches covered.">        if(index == 8){</span>
      
<span class="fc" id="L165">            data = buffer;</span>
<span class="fc" id="L166">            index = 0;</span>
<span class="fc" id="L167">            buffer = 0;</span>
<span class="fc" id="L168">            fillInBuffer();</span>
<span class="fc" id="L169">            return data;</span>
        }else{
<span class="fc" id="L171">            data = buffer;</span>
<span class="fc" id="L172">            int localIndex = index;</span>
<span class="fc" id="L173">            buffer = 0;</span>
<span class="fc" id="L174">            index = 0;</span>
<span class="fc" id="L175">            fillInBuffer();</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">            if(inEmpty()) throw new NoSuchElementException(&quot;Eof&quot;);</span>
<span class="fc" id="L177">            data &lt;&lt;= (8-localIndex);</span>
<span class="fc" id="L178">            index = localIndex;</span>
<span class="fc" id="L179">            data |= (buffer &gt;&gt;&gt; index);</span>
<span class="fc" id="L180">            return data%256;</span>
            
            
            
            
        }
      
        
    }
    public int getInCounter(){
<span class="nc" id="L190">        return this.inCounter;</span>
    }
    public int getOutCounter(){
<span class="fc" id="L193">        return this.outCounter;</span>
    }
    private void writeOutput(){
        try{
<span class="fc" id="L197">            ioOut.write(outBuffer);</span>
        
          //  System.out.println(&quot;wrote byte: &quot;+outBuffer);
<span class="fc" id="L200">            outBuffer = 0;</span>
<span class="fc" id="L201">            outIndex = 0;</span>
<span class="fc" id="L202">            outCounter++;</span>
            
<span class="nc" id="L204">        }catch(IOException e){</span>
<span class="nc" id="L205">            System.out.println(&quot;Exception in writing to file: &quot;+e.getLocalizedMessage() );</span>
<span class="fc" id="L206">        }</span>
<span class="fc" id="L207">    }</span>
    public void writeBoolean(boolean bit){
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L210">        outBuffer &lt;&lt;= 1; //add one bit to right</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if(bit) outBuffer |= 1;</span>
         //System.out.println(&quot;wrote out: &quot;+bit);
<span class="fc" id="L213">        outIndex++;</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">        if(outIndex &gt;= 8) writeOutput();</span>
<span class="fc" id="L215">    }</span>
    public void writeByte(int value){
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);    </span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">        if(outIndex == 0){</span>
           // System.out.println(&quot;writing a full byte&quot;);
<span class="fc" id="L220">            outBuffer = value;</span>
<span class="fc" id="L221">            outIndex = 8;</span>
<span class="fc" id="L222">            writeOutput();</span>
        }else{
          //  System.out.println(&quot;writing byte bit by bit&quot;);
<span class="fc bfc" id="L225" title="All 2 branches covered.">              for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">            boolean bit = ((value &gt;&gt;&gt; (8 - i - 1)) &amp; 1) == 1;</span>
<span class="fc" id="L227">            writeBoolean(bit);</span>
                 
        }
//            for(int i = 7; i&lt;=0;i--){
//                System.out.println(&quot;adding individual bits: &quot;+i);
//                 if(value &lt;&lt; ~i&lt;0){
//                     writeBoolean(true);
//                     System.out.println(&quot;true&quot;);
//                 }else{
//                     writeBoolean(false);
//                     System.out.println(&quot;false&quot;);
//                 }
//            }
        }
<span class="fc" id="L241">    }</span>
    /**
     * Writes integer with the predefined length as bits out.
     * Will throw exception if the length is larger than max int length 32
     * @param value the value to be written
     * @param length the amount of bits to be used
     */
    public void writeInt(int value, int length){
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if(length == 32 ){</span>
<span class="nc" id="L250">            writeInt(value);</span>
        }
<span class="pc bpc" id="L252" title="2 of 4 branches missed.">        if(length &lt; 1 || length &gt; 32) throw new IllegalStateException(&quot;illegal int length&quot;);</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">        for(int i = 0; i&lt;length;i++){</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">               boolean bit = ((value &gt;&gt;&gt; (length - i - 1)) &amp; 1) == 1;</span>
<span class="fc" id="L255">               writeBoolean(bit);</span>
        }
<span class="fc" id="L257">    }</span>
    public int readInt(int length){
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">        if(length == 32) return readInt();</span>
<span class="pc bpc" id="L260" title="2 of 4 branches missed.">        if(length &lt; 1 || length &gt; 32) throw new IllegalStateException(&quot;illegal int length&quot;);</span>
<span class="fc" id="L261">        int result = 0;</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">        for(int i = 0; i&lt; length;i++){</span>
<span class="fc" id="L263">            boolean bit = readBit();</span>
<span class="fc" id="L264">            result &lt;&lt;= 1;</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">            if(bit){</span>
<span class="fc" id="L266">                result |= 1;</span>
            }
        }
        
        
<span class="fc" id="L271">        return result;</span>
    }
    public void writeInt(int value){
<span class="fc" id="L274">        byte[] b = ByteBuffer.allocate(4).putInt(value).array();</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">        for(int i = 0; i&lt;4;i++){</span>
<span class="fc" id="L276">            writeByte(b[i]);</span>
        }
        
<span class="fc" id="L279">    }</span>
    /**
     * Reads 4 bytes from disk and returns it as integer
     * @return integer value of 4 next bytes
     */
    public int readInt(){
<span class="fc" id="L285">        byte[] b = new byte[4];</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">        for(int i = 0; i&lt;4;i++){</span>
<span class="fc" id="L287">            int x = readByteAsInt();</span>
<span class="fc" id="L288">            b[i] =(byte) (x &amp; 0xff);</span>
        }
<span class="fc" id="L290">        return ByteBuffer.wrap(b).getInt();</span>
        
    }
    public void close(){
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">        if(!active) throw new IllegalStateException(&quot;No active input/output streams&quot;);</span>
<span class="fc" id="L295">        this.active = false;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">        if(outIndex&gt;0){</span>
<span class="fc" id="L297">            outBuffer &lt;&lt;= (8-outIndex); // pad last byte with zeroes to end.</span>
<span class="fc" id="L298">            writeOutput();</span>
        }
        try{
<span class="fc" id="L301">            ioOut.flush();</span>
<span class="fc" id="L302">            ioIn.close();</span>
<span class="fc" id="L303">            ioOut.close();</span>
<span class="nc" id="L304">        }catch(IOException e){</span>
<span class="nc" id="L305">            System.out.println(&quot;Exception in closing file inteface: &quot;+e.getLocalizedMessage());</span>
<span class="fc" id="L306">        }</span>
<span class="fc" id="L307">    }  </span>
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>